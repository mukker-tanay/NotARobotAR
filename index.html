<!DOCTYPE html>
<html>
<head>
    <title>Human Battery Test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-face-aframe.prod.js"></script>

    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; }
        
        /* 2. The Battery UI Overlay */
        #ui-layer {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            text-align: center;
            background: rgba(0, 0, 0, 0.6);
            padding: 15px;
            border-radius: 15px;
            width: 200px;
        }

        #battery-container {
            width: 100%;
            height: 30px;
            background: #333;
            border: 2px solid white;
            border-radius: 5px;
            position: relative;
            overflow: hidden;
        }

        #battery-fill {
            height: 100%;
            width: 20%; /* Starting charge */
            background: red;
            transition: width 0.2s, background 0.2s;
        }

        #percentage-text {
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            margin-top: 5px;
        }

        #status-text {
            color: #ccc;
            font-size: 0.8rem;
            margin-top: 5px;
        }
    </style>
</head>
<body>

    <a-scene mindar-face embedded vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
        
        <a-camera active="false" position="0 0 0"></a-camera>
        
        <a-entity mindar-face-target="anchorIndex: 1" id="nose-tracker">
            </a-entity>

    </a-scene>

    <div id="ui-layer">
        <div id="battery-container">
            <div id="battery-fill"></div>
        </div>
        <div id="percentage-text">20%</div>
        <div id="status-text">MOVE TO CHARGE!</div>
    </div>

    <script>
        // Configuration
        const CHARGE_SPEED = 2.0;       // How fast it charges
        const DRAIN_SPEED = 0.5;        // How fast it drains
        const MOVEMENT_THRESHOLD = 0.005; // Sensitivity to movement

        // Variables
        let batteryLevel = 20;
        let lastPosition = null;
        const noseEntity = document.querySelector('#nose-tracker');
        const fillBar = document.querySelector('#battery-fill');
        const textLabel = document.querySelector('#percentage-text');
        const statusLabel = document.querySelector('#status-text');

        // Main Game Loop (Runs every 100ms)
        setInterval(() => {
            // Get current 3D position of the nose
            const currentPos = noseEntity.object3D.position;

            // Ensure we have a previous frame to compare against
            if (lastPosition) {
                // Calculate distance moved (Velocity)
                const dx = currentPos.x - lastPosition.x;
                const dy = currentPos.y - lastPosition.y;
                const dz = currentPos.z - lastPosition.z;
                const speed = Math.sqrt(dx*dx + dy*dy + dz*dz);

                // Game Logic
                if (speed > MOVEMENT_THRESHOLD) {
                    batteryLevel += CHARGE_SPEED;
                    statusLabel.textContent = "CHARGING... ⚡";
                    statusLabel.style.color = "#0f0";
                } else {
                    batteryLevel -= DRAIN_SPEED;
                    statusLabel.textContent = "DRAINING... ⚠️";
                    statusLabel.style.color = "#ccc";
                }

                // Clamp values (Keep between 0 and 100)
                if (batteryLevel > 100) batteryLevel = 100;
                if (batteryLevel < 0) batteryLevel = 0;

                // Update UI
                updateBatteryUI(batteryLevel);
            }

            // Save current position for next frame
            // We clone it because object3D.position is a reference that changes
            lastPosition = { x: currentPos.x, y: currentPos.y, z: currentPos.z };

        }, 100);

        function updateBatteryUI(level) {
            textLabel.innerText = Math.floor(level) + "%";
            fillBar.style.width = level + "%";

            // Change Color based on level
            if (level < 20) {
                fillBar.style.background = "#ff3b30"; // Red
            } else if (level < 99) {
                fillBar.style.background = "#ffcc00"; // Yellow
            } else {
                fillBar.style.background = "#4cd964"; // Green
                statusLabel.textContent = "HUMAN CONFIRMED ✅";
            }
        }
    </script>
</body>
</html>